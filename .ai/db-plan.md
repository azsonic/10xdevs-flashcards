# 10xdevs-flashcards Database Schema

This document outlines the PostgreSQL database schema for the 10xdevs-flashcards application, designed to run on Supabase.

## 1. List of Tables

### `flashcards`

Stores the content for each flashcard created by a user.

| Column | Data Type | Constraints | Description |
|---|---|---|---|
| `id` | `bigserial` | `PRIMARY KEY` | Unique identifier for the flashcard. |
| `user_id` | `uuid` | `NOT NULL`, `FOREIGN KEY REFERENCES auth.users(id) ON DELETE CASCADE` | The user who owns the flashcard. |
| `generation_id` | `bigint` | `NULL`, `FOREIGN KEY REFERENCES generations(id) ON DELETE SET NULL` | The AI generation event that created the card. |
| `front` | `varchar(200)` | `NOT NULL` | The front content of the flashcard. |
| `back` | `varchar(500)` | `NOT NULL` | The back content of the flashcard. |
| `source` | `varchar` | `NOT NULL`, `CHECK (source IN ('ai-full', 'ai-edited', 'manual'))` | The origin of the flashcard. |
| `created_at` | `timestamptz` | `NOT NULL`, `DEFAULT now()` | Timestamp when the flashcard was created. |
| `updated_at` | `timestamptz` | `NOT NULL`, `DEFAULT now()` | Timestamp when the flashcard was last updated. |

---

### `generations`

Logs metadata for each successful AI flashcard generation event.

| Column | Data Type | Constraints | Description |
|---|---|---|---|
| `id` | `bigserial` | `PRIMARY KEY` | Unique identifier for the generation event. |
| `user_id` | `uuid` | `NOT NULL`, `FOREIGN KEY REFERENCES auth.users(id) ON DELETE CASCADE` | The user who initiated the generation. |
| `model` | `varchar` | `NOT NULL` | The AI model used for generation. |
| `generated_count` | `integer` | `NOT NULL` | The number of flashcard candidates generated by the AI. |
| `accepted_unedited_count` | `integer` | | The number of candidates the user accepted as-is. |
| `accepted_edited_count` | `integer` | | The number of candidates the user accepted after editing. |
| `source_text_hash` | `varchar` | `NOT NULL` | SHA-256 hash of the source text. |
| `source_text_length` | `integer` | `NOT NULL`, `CHECK (source_text_length BETWEEN 1000 AND 10000)` | Length of the source text. |
| `generation_duration` | `integer` | `NOT NULL` | The duration of the generation process in milliseconds. |
| `created_at` | `timestamptz` | `NOT NULL`, `DEFAULT now()` | Timestamp when the generation event occurred. |
| `updated_at` | `timestamptz` | `NOT NULL`, `DEFAULT now()` | Timestamp when the generation log was last updated. |

---

### `generation_error_logs`

Logs details of failed AI generation attempts.

| Column | Data Type | Constraints | Description |
|---|---|---|---|
| `id` | `bigserial` | `PRIMARY KEY` | Unique identifier for the error log entry. |
| `user_id` | `uuid` | `NOT NULL`, `FOREIGN KEY REFERENCES auth.users(id) ON DELETE CASCADE` | The user who experienced the error. |
| `model` | `varchar` | `NOT NULL` | The AI model used for generation. |
| `source_text_hash` | `varchar` | `NOT NULL` | SHA-256 hash of the source text. |
| `source_text_length` | `integer` | `NOT NULL`, `CHECK (source_text_length BETWEEN 1000 AND 10000)` | Length of the source text. |
| `error_code` | `varchar(100)` | `NOT NULL` | A code identifying the type of error. |
| `error_message` | `text` | `NOT NULL` | The error message or reason for the failure. |
| `created_at` | `timestamptz` | `NOT NULL`, `DEFAULT now()` | Timestamp when the error occurred. |

## 2. Relationships Between Tables

- **`users` (from `auth.users`) and `flashcards`**: One-to-Many.
- **`users` and `generations`**: One-to-Many.
- **`users` and `generation_error_logs`**: One-to-Many.
- **`generations` and `flashcards`**: One-to-Many (optional).

## 3. Indexes

- **`flashcards` table:**
  - `flashcards_pkey`: Primary key index on `id`.
  - `flashcards_user_id_idx`: B-tree index on `user_id`.
  - `flashcards_generation_id_idx`: B-tree index on `generation_id`.
  - `flashcards_full_text_idx`: GIN index on `(front, back)` to support efficient full-text search.
- **`generations` table:**
  - `generations_pkey`: Primary key index on `id`.
  - `generations_user_id_idx`: B-tree index on `user_id`.
- **`generation_error_logs` table:**
  - `generation_error_logs_pkey`: Primary key index on `id`.
  - `generation_error_logs_user_id_idx`: B-tree index on `user_id`.

## 4. PostgreSQL Policies (RLS)

- **`flashcards` table policy:** Enables `SELECT`, `INSERT`, `UPDATE`, `DELETE` for users where `auth.uid() = user_id`.
- **`generations` table policy:** Enables `SELECT`, `INSERT`, `UPDATE`, `DELETE` for users where `auth.uid() = user_id`.
- **`generation_error_logs` table policy:** Enables `SELECT`, `INSERT`, `UPDATE`, `DELETE` for users where `auth.uid() = user_id`.

## 5. Triggers

### `handle_updated_at` Function

This generic trigger function updates the `updated_at` column of a table to the current timestamp.

```sql
CREATE OR REPLACE FUNCTION handle_updated_at()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = now();
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;
```

### Triggers

- **On `flashcards` table:**
  ```sql
  CREATE TRIGGER flashcards_updated_at_trigger
  BEFORE UPDATE ON flashcards
  FOR EACH ROW
  EXECUTE FUNCTION handle_updated_at();
  ```
- **On `generations` table:**
  ```sql
  CREATE TRIGGER generations_updated_at_trigger
  BEFORE UPDATE ON generations
  FOR EACH ROW
  EXECUTE FUNCTION handle_updated_at();
  ```

## 6. Additional Notes

- **Primary Key Strategy**: All custom tables use `bigserial` (auto-incrementing `bigint`) for primary keys.
- **Flashcard Origin**: The `flashcards.source` column explicitly tracks the card's origin.
- **Timestamp Automation**: `created_at` timestamps are set by default. `updated_at` timestamps on `flashcards` and `generations` are automatically managed by triggers.
- **Spaced Repetition System (SRS)**: SRS-related fields are excluded from this schema and will be added later.
